const API_LIST="/api/products/";const API_CREATE="/api/products/create/";const API_UPDATE=id=>`/api/products/${id}/update/`;const API_DELETE=id=>`/api/products/${id}/delete/`;const grid=document.getElementById('grid');const loadingBox=document.getElementById('loading');const errorBox=document.getElementById('error');const emptyBox=document.getElementById('empty');const refreshBtn=document.getElementById('refreshBtn');const createBtn=document.getElementById('createBtn');function state({loading=false,error=null,items=null}){loadingBox?.classList.toggle('hidden',!loading);errorBox?.classList.toggle('hidden',!error);grid?.classList.toggle('hidden',!!(loading||error||(items&&items.length===0)));emptyBox?.classList.toggle('hidden',!(items&&items.length===0));if(error){errorBox.innerHTML=`<div class="bg-red-50 border border-red-200 text-red-700 p-4 rounded"> ${error} </div>`;}if(items&&items.length>0){grid.className='grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6';}}function productCard(p){const el=document.createElement('article');el.className='bg-white rounded-lg border border-gray-200 hover:shadow transition overflow-hidden flex flex-col';el.innerHTML=`<div class="aspect-[16/9] bg-gray-100 overflow-hidden">${p.thumbnail?`<img src="${p.thumbnail}" alt="${p.name}" class="w-full h-full object-cover">`:''}</div><div class="p-4 flex-1 flex flex-col"><div class="flex items-center justify-between mb-1"><h3 class="font-semibold text-lg">${p.name}</h3>${p.is_featured?'<span class="text-xs px-2 py-1 rounded bg-yellow-100 text-yellow-800">Featured</span>':''}</div><p class="text-sm text-gray-600 line-clamp-2 mb-2">${p.description||''}</p><div class="text-sm text-gray-700 mb-3">Brand: ${p.brand||'-'} â€¢ Rating: ${p.rating?.toFixed?p.rating.toFixed(1):p.rating||'-'}</div><div class="mt-auto flex items-center justify-between"><div class="font-bold">Rp ${Number(p.price).toLocaleString('id-ID')}</div><div class="text-sm text-gray-600">Stok: ${p.stock}</div></div><div class="mt-3 flex gap-2"><button class="px-3 py-2 border rounded hover:bg-gray-50" data-action="edit" data-id="${p.id}">Edit</button><button class="px-3 py-2 bg-red-600 text-white rounded" data-action="delete" data-id="${p.id}">Delete</button></div></div>`;el.querySelectorAll('button').forEach(btn=>{btn.addEventListener('click',e=>{const id=e.currentTarget.dataset.id;const act=e.currentTarget.dataset.action;if(act==='edit'){showModal('update',p);}if(act==='delete'){showConfirm(async()=>{try{await jsonFetch(API_DELETE(id),{method:'POST'});showToast('Deleted','Produk dihapus','success');loadProducts();}catch(err){showToast('Error',err.message,'error');}});}});});return el;}async function loadProducts(){try{state({loading:true});const items=await jsonFetch(API_LIST);grid.innerHTML='';if(!items||items.length===0){state({items:[]});return;}items.forEach(p=>grid.appendChild(productCard(p)));state({items});}catch(err){state({error:err.message||'Gagal memuat'});}}refreshBtn?.addEventListener('click',()=>loadProducts());createBtn?.addEventListener('click',()=>showModal('create'));document.getElementById('productForm')?.addEventListener('submit',async e=>{e.preventDefault();const form=e.currentTarget;const data=new FormData(form);const id=document.getElementById('productId').value;const url=id?API_UPDATE(id):API_CREATE;try{await jsonFetch(url,{method:'POST',body:data});hideModal();showToast(id?'Updated':'Created','Produk tersimpan','success');form.reset();loadProducts();}catch(err){showToast('Error',err.message,'error');}});if(grid){loadProducts();}
